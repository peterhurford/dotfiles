require 'test_helper'

class Api::PromotionsControllerTest < ActionController::TestCase

  let(:preapproved_record) { FactoryGirl.create(:preapproved_record) }
  let(:promotion)          { FactoryGirl.create(:promotion) }

  before do
    CustomerApplication.stubs(:landing_page_promo_contents).returns([{
      "code" => preapproved_record.url,
      "promotion_id" => promotion.id
    }])
  end

  it "should return 400 with invalid personalized promo code" do
    post :create, { coupon_code: "abcdef" }

    assert_response 400
  end

  it "should return 400 when personalized promo code is missing" do
    post :create, { coupon_code: nil }

    assert_response 400
  end

  it "should return Promotion when personalized promo code is valid and matching" do
    post :create, { coupon_code: preapproved_record.promo_code }

    assert_response 200
    assert @response.body, promotion.to_json
  end

end
