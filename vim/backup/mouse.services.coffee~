'use strict'

angular.module 'threeManChessApp'
.factory 'Mouse', ($rootScope) ->
  $rootScope.cartesianToPolar = (x, y) ->
    r = Math.sqrt(x*x + y*y)
    theta = Math.atan(y/x) / (2 * Math.PI) * 360
    theta += 180 if x < 0
    theta += 360 if x > 0 and y < 0
    {r: r, theta: theta}

  $rootScope.getMousePos = (canvas, e) ->
    rect = canvas.getBoundingClientRect()
    x = e.clientX - rect.left - 300
    y = e.clientY - rect.top - 300
    polar_c = $rootScope.cartesianToPolar(x, y)
    {
      x: Math.floor(polar_c.theta / 15),
      y: 5 - Math.floor((polar_c.r - 75) / 35)
    }

  $rootScope.write = (ctx, canvas, message) ->
    ctx.clearRect(0, 0, canvas.width/2, 40)
    ctx.font = '18pt Calibri'
    ctx.fillStyle = 'black'
    ctx.fillText(message, 10, 25)
  

  onMouseMove: (ctx, canvas, chessboard, e) ->
    mousePos = $rootScope.getMousePos(canvas, e)
    piece = chessboard.piece_at(mousePos.x, mousePos.y)
    message = "#{mousePos.x}, #{mousePos.y}" ##{piece.type}"
    $rootScope.write(ctx, canvas, message)
    
    if piece && !$rootScope.picked_piece
      $rootScope.available_moves = piece.moves()
     else if !$rootScope.picked_piece
      $rootScope.available_moves = []
    
    scope.drawBoard(available_moves)
      #scope.place(canvas, ctx, 'R', 'B', mousePos.x, mousePos.y) if mousePos.x >= 0 and mousePos.x <= 24 and mousePos.y >= 0 and mousePos.y <= 5
      
    scope.placePieces(canvas, ctx, chessboard)

