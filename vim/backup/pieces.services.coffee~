'use strict'

angular.module 'threeManChessApp'
.factory 'Pieces', ($rootScope) ->
  $rootScope.place = (canvas, ctx, piece, color, x, y) ->
    piece_match = {
      'K': '♚',
      'Q': '♛',
      'R': '♜',
      'B': '♝',
      'N': '♞',
      'P': '♟'
    }
    color_match = {
      'B': { bg: '#000000', outline: '#777777', width: 0.5 }
      'G': { bg: '#777777', outline: '#000000', width: 1.5 }
      'W': { bg: '#ffffff', outline: '#000000', width: 2 }
    }
    ctx.lineWidth = color_match[color].width
    piece_size = 36
    board_size = 600
    ctx.font = "#{piece_size}px Arial"
    ctx.fillStyle = color_match[color].bg
    ctx.strokeStyle = color_match[color].color
    tmp3_x = board_size / 2 + Math.cos(Math.PI * 3 /2) * piece_size / 16
    tmp3_y = board_size / 2 - Math.sin(Math.PI * 3 /2) * piece_size / 16

    ctx.translate(tmp3_x, tmp3_y)
    rad = (1+2*x)/48 * Math.PI*2
    ctx.rotate(tmp_rad = rad + Math.PI * 3 / 2)
    rad -= (1.5+2*x)/48 * Math.PI*2
    ctx.translate(
      tmp_x = Math.sin(rad) * (board_size / 2 - piece_size / 8 - 3 - (y) * 1 / 6 * board_size * (1 / 2 - 1 / 8)),
      tmp_y = Math.cos(rad) * (board_size / 2 - piece_size / 8 - 3 - (y) * 1 / 6 * board_size * (1 / 2 - 1 / 8))
    )
    ctx.fillText(piece_match[piece], 0, 0)
    ctx.strokeText(piece_match[piece], 0, 0)
    ctx.translate(-tmp_x, -tmp_y)
    ctx.rotate(-tmp_rad)
    ctx.translate(-tmp3_x, -tmp3_y)


  place: (canvas, ctx, piece, color, x, y) ->
    $rootScope.place(canvas, ctx, piece, color, x, y)


  placePieces: (canvas, ctx, chessboard) ->
    type_map = { 'rook': 'R', 'knight': 'N', bishop: 'B', king: 'K', queen: 'Q', pawn: 'P' }
    color_map = { white: 'W', black: 'B', grey: 'G' }
    for y in [0..5]
      for x in [0..23]
        p = chessboard.piece_at(x, y)
        continue if !p?
        $rootScope.place(canvas, ctx, type_map[p.type], color_map[p.color], x, y)

